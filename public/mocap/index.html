<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestalt ¬∑ Motion Capture</title>
  <!-- i18n Translation Script -->
  <script src="/lang/translations.js"></script>
  <style>
    /* =========================================
       MINIMAL ELEGANT THEME - ÁÆÄÁ∫¶È´òÁ∫ßÈ£éÊ†º
       ========================================= */
    :root {
      --accent: #667eea;
      --accent-dim: rgba(102, 126, 234, 0.15);
      --bg-dark: #0a0a0f;
      --bg-panel: rgba(20, 20, 30, 0.9);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --success: #4ade80;
      --error: #f87171;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      overflow: hidden;
    }

    .container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- È°∂ÈÉ®‰ø°ÊÅØÊ†è --- */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      padding: 0 30px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: var(--text-primary);
      opacity: 0.9;
    }
    
    .brand-gestalt {
      font-weight: 700;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status-panel {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Ê†áÁ≠æÈÄöÁî®Ê†∑Âºè */
    .performer-badge, .status, .fps {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .performer-badge {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .status {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    .status.connected {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
      color: var(--success);
    }

    .status.disconnected {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.3);
      color: var(--error);
    }

    .fps {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      font-family: 'SF Mono', 'Menlo', monospace;
    }

    /* --- ËßÜÈ¢ë‰∏ªÂå∫Âüü --- */
    .main-content {
      flex: 1;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
    }

    .video-canvas-container {
      position: relative;
      max-width: 90%;
      max-height: 85%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    #videoElement {
      width: 100%;
      height: auto;
      display: block;
      transform: scaleX(-1);
    }

    #canvasElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; 
    }

    /* --- Âä†ËΩΩÁïåÈù¢ --- */
    #loading {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-dark);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 1000;
    }

    #loading.hidden { display: none; }

    .loading-spinner {
      width: 40px; 
      height: 40px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      margin-top: 24px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    /* --- ÈîôËØØÁïåÈù¢ --- */
    #error {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-dark);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 1000;
    }

    #error.hidden { display: none; }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    #errorMessage {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      text-align: center;
      max-width: 400px;
    }

    #retryBtn {
      padding: 10px 24px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    #retryBtn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* --- ÊéßÂà∂Èù¢Êùø --- */
    .controls {
      position: absolute;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }

    .control-btn {
      padding: 12px 20px;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 140px;
      text-align: left;
      backdrop-filter: blur(10px);
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .control-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    /* --- Language Switcher --- */
    .lang-switcher {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .lang-switcher:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    /* --- ÂèÇÊï∞Èù¢Êùø --- */
    .params-display {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 260px;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      font-size: 12px;
      line-height: 1.6;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .params-display.hidden {
      display: none;
    }

    .params-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .param-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .param-label {
      color: var(--text-secondary);
    }

    .param-value {
      color: var(--text-primary);
      font-family: 'SF Mono', 'Menlo', monospace;
      font-weight: 500;
    }

    /* --- Êò†Â∞ÑÁºñËæëÂô® Modal --- */
    .mapping-editor-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .mapping-editor-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .mapping-editor {
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }

    .mapping-editor-overlay.visible .mapping-editor {
      transform: scale(1);
    }

    .mapping-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.3);
    }

    .mapping-editor-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mapping-editor-actions {
      display: flex;
      gap: 8px;
    }

    .mapping-editor-btn {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mapping-editor-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    .mapping-editor-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .mapping-editor-btn.primary:hover {
      opacity: 0.9;
    }

    .mapping-editor-btn.danger {
      color: var(--error);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .mapping-editor-btn.danger:hover {
      background: rgba(248, 113, 113, 0.15);
    }

    .mapping-editor-close {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.08);
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mapping-editor-close:hover {
      background: rgba(248, 113, 113, 0.2);
      color: var(--error);
    }

    .mapping-editor-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    /* Êò†Â∞ÑÈ°π */
    .mapping-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .mapping-item:hover {
      border-color: rgba(102, 126, 234, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }

    .mapping-item.disabled {
      opacity: 0.5;
    }

    .mapping-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .mapping-item-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mapping-item-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }

    .mapping-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mapping-toggle.active {
      background: var(--accent);
    }

    .mapping-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .mapping-toggle.active::after {
      left: 22px;
    }

    .mapping-item-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .mapping-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mapping-field.full-width {
      grid-column: 1 / -1;
    }

    .mapping-field label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mapping-field input {
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'SF Mono', 'Menlo', monospace;
      transition: all 0.2s;
    }

    .mapping-field input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0, 0, 0, 0.4);
    }

    .mapping-field input::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }

    .mapping-range-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mapping-range-group input {
      width: 70px;
      text-align: center;
    }

    .mapping-range-group span {
      color: var(--text-secondary);
    }

    .mapping-smooth-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mapping-smooth-toggle {
      width: 36px;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }

    .mapping-smooth-toggle.active {
      background: var(--success);
    }

    .mapping-smooth-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .mapping-smooth-toggle.active::after {
      left: 18px;
    }

    .mapping-smooth-factor {
      width: 60px;
    }

    /* ÊèêÁ§∫Ê∂àÊÅØ */
    .mapping-toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .mapping-toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .mapping-toast.success {
      border-color: var(--success);
      background: rgba(74, 222, 128, 0.15);
    }

    .mapping-toast.error {
      border-color: var(--error);
      background: rgba(248, 113, 113, 0.15);
    }

    /* ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• */
    .hidden-file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Â§¥ÈÉ®‰ø°ÊÅØ / Header -->
    <div class="header">
      <div class="title"><span class="brand-gestalt">Gestalt</span> ¬∑ <span data-i18n="mocap.pageTitle">Motion Capture</span></div>
      <div class="status-panel">
        <button class="lang-switcher" id="langBtn" onclick="toggleLanguageAndReload()">üåç EN</button>
        <div class="performer-badge" id="performerBadge"><span data-i18n="common.performer">Performer</span> 1</div>
        <div class="performer-badge" id="audienceCountBadge">üë• <span data-i18n="common.audience">Audience</span>: 0</div>
        <div class="status disconnected" id="oscStatus">OSC <span data-i18n="common.disconnected">Disconnected</span></div>
        <div class="fps" id="fps">FPS: 0</div>
      </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
      <div class="video-canvas-container">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement"></canvas>
      </div>
    </div>

    <!-- ÊéßÂà∂ÊåâÈíÆ / Control Buttons -->
    <div class="controls">
      <button class="control-btn active" id="toggleSkeletonBtn">ü¶¥ <span id="skeletonText">Show Skeleton</span></button>
      <button class="control-btn" id="toggleParamsBtn">üìä <span id="paramsText">Show Params</span></button>
      <button class="control-btn" id="openMappingEditorBtn">üéõÔ∏è <span id="mappingEditorText">Mapping Editor</span></button>
      <button class="control-btn" id="fullscreenBtn">‚õ∂ <span id="fullscreenText">Fullscreen</span></button>
    </div>

    <!-- Êò†Â∞ÑÁºñËæëÂô® Modal / Mapping Editor Modal -->
    <div class="mapping-editor-overlay" id="mappingEditorOverlay">
      <div class="mapping-editor">
        <div class="mapping-editor-header">
          <h2>üéõÔ∏è <span id="mappingEditorTitle">Performer Mapping Editor</span></h2>
          <div class="mapping-editor-actions">
            <button class="mapping-editor-btn" id="exportConfigBtn">üì§ <span data-i18n="mappingEditor.export">Export</span></button>
            <button class="mapping-editor-btn" id="importConfigBtn">üì• <span data-i18n="mappingEditor.import">Import</span></button>
            <button class="mapping-editor-btn danger" id="resetConfigBtn">üîÑ <span data-i18n="mappingEditor.reset">Reset</span></button>
            <button class="mapping-editor-close" id="closeMappingEditorBtn">‚úï</button>
          </div>
        </div>
        <div class="mapping-editor-content" id="mappingEditorContent">
          <!-- Êò†Â∞ÑÈ°π‰ºöÈÄöËøá JS Âä®ÊÄÅÁîüÊàê -->
        </div>
      </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
    <input type="file" class="hidden-file-input" id="importFileInput" accept=".json">
    
    <!-- Toast Ê∂àÊÅØ -->
    <div class="mapping-toast" id="mappingToast"></div>

    <!-- ÂèÇÊï∞ÊòæÁ§∫ / Parameter Display -->
    <div class="params-display hidden" id="paramsDisplay">
      <div class="params-title" data-i18n="mocap.parameters">Parameters</div>
      <div id="paramsContent"></div>
    </div>

    <!-- Âä†ËΩΩÁïåÈù¢ / Loading Screen -->
    <div id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="common.loading">Loading...</div>
    </div>

    <!-- ÈîôËØØÁïåÈù¢ / Error Screen -->
    <div id="error" class="hidden">
      <div class="error-icon">‚ö†Ô∏è</div>
      <div id="errorMessage" data-i18n="common.error">An error occurred</div>
      <button id="retryBtn" id="retryText">Retry</button>
    </div>
  </div>

  <!-- MediaPipe Tasks Vision -->
  <script type="importmap">
    {
      "imports": {
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs"
      }
    }
  </script>

  <!-- i18n Initialization -->
  <script>
    // Update page language and texts on load
    document.addEventListener('DOMContentLoaded', function() {
      // Apply translations
      if (window.i18n) {
        window.i18n.applyTranslations();
        
        // Update language button
        const lang = window.i18n.getCurrentLanguage();
        const langBtn = document.getElementById('langBtn');
        if (langBtn) {
          langBtn.textContent = lang === 'en' ? 'üåç ‰∏≠Êñá' : 'üåç EN';
        }
        
        // Update page title
        document.title = window.i18n.t('mocap.title');
        
        // Update button texts based on language
        const texts = window.i18n.getTranslations();
        document.getElementById('skeletonText').textContent = lang === 'zh' ? 'ÊòæÁ§∫È™®È™º' : 'Show Skeleton';
        document.getElementById('paramsText').textContent = lang === 'zh' ? 'ÊòæÁ§∫ÂèÇÊï∞' : 'Show Params';
        document.getElementById('fullscreenText').textContent = lang === 'zh' ? 'ÂÖ®Â±è' : 'Fullscreen';
        
        // Update retry button
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn) {
          retryBtn.textContent = lang === 'zh' ? 'ÈáçËØï' : 'Retry';
        }
      }
    });
    
    // Update OSC status text based on language
    window.updateOscStatus = function(connected) {
      const oscStatus = document.getElementById('oscStatus');
      if (oscStatus && window.i18n) {
        const lang = window.i18n.getCurrentLanguage();
        if (connected) {
          oscStatus.className = 'status connected';
          oscStatus.textContent = 'OSC ' + (lang === 'zh' ? 'Â∑≤ËøûÊé•' : 'Connected');
        } else {
          oscStatus.className = 'status disconnected';
          oscStatus.textContent = 'OSC ' + (lang === 'zh' ? 'Êú™ËøûÊé•' : 'Disconnected');
        }
      }
    };
  </script>

  <!-- ‰∏ªÂ∫îÁî®ËÑöÊú¨ÔºàÁÆÄÂåñÁâàÔºåÊó† Three.jsÔºâ / Main Script -->
  <script type="module" src="./mocap-simple.js"></script>
</body>
</html>
