<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Audio å¼•æ“ - OSC æ§åˆ¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
        }
        
        .container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }
        
        .subtitle {
            text-align: center;
            font-size: 18px;
            color: #aaa;
            margin-bottom: 40px;
        }
        
        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff3333;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.8);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-text {
            font-size: 20px;
            font-weight: 600;
        }
        
        .start-button {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.5);
        }
        
        .start-button:active {
            transform: translateY(0);
        }
        
        .start-button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .info-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ffff;
        }
        
        .log-container {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #00ffff;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 5px;
            border-left: 3px solid #00ffff;
            margin-bottom: 5px;
            padding-left: 10px;
        }
        
        .log-entry.error {
            border-left-color: #ff3333;
            color: #ff9999;
        }
        
        .log-entry.warning {
            border-left-color: #ffaa00;
            color: #ffcc88;
        }
        
        .visualizer {
            margin-top: 30px;
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(180deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5));
            filter: blur(20px);
            animation: wave 3s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ WEB AUDIO ENGINE</h1>
        <p class="subtitle">æ›¿ä»£ MaxMSP + Pigments çš„æµè§ˆå™¨éŸ³é¢‘å¼•æ“</p>
        
        <div class="status">
            <div class="status-indicator" id="statusIndicator"></div>
            <div class="status-text" id="statusText">æœªè¿æ¥</div>
        </div>
        
        <button class="start-button" id="startButton">
            å¯åŠ¨éŸ³é¢‘å¼•æ“
        </button>
        
        <button class="start-button" id="toggleMusicButton" style="display: none; margin-top: 20px; background: linear-gradient(45deg, #ff6b6b, #feca57);">
            â¸ï¸ æš‚åœç”Ÿæˆå¼éŸ³ä¹
        </button>
        
        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">WebSocket</div>
                <div class="info-value" id="wsStatus">âŒ</div>
            </div>
            <div class="info-card">
                <div class="info-label">æ¥æ”¶æ¶ˆæ¯</div>
                <div class="info-value" id="messageCount">0</div>
            </div>
            <div class="info-card">
                <div class="info-label">å»¶è¿Ÿ (ms)</div>
                <div class="info-value" id="latency">--</div>
            </div>
            <div class="info-card">
                <div class="info-label">CPUå ç”¨</div>
                <div class="info-value" id="cpuUsage">ä½</div>
            </div>
        </div>
        
        <div class="visualizer">
            <div class="wave"></div>
        </div>
        
        <div class="log-container">
            <div class="log-title">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</div>
            <div id="logContent">
                <div class="log-entry">ç­‰å¾…å¯åŠ¨...</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { audioEngine } from './audio-engine.js';
        import { getAllAddresses } from './osc-mapping.js';
        
        // UI å…ƒç´ 
        const startButton = document.getElementById('startButton');
        const toggleMusicButton = document.getElementById('toggleMusicButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const wsStatus = document.getElementById('wsStatus');
        const messageCount = document.getElementById('messageCount');
        const latency = document.getElementById('latency');
        const logContent = document.getElementById('logContent');
        
        let messageCounter = 0;
        let ws = null;
        let lastMessageTime = Date.now();
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logContent.children.length > 50) {
                logContent.removeChild(logContent.children[0]);
            }
        }
        
        // è¿æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            addLog(`æ­£åœ¨è¿æ¥ WebSocket: ${wsUrl}...`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                addLog('âœ… WebSocket å·²è¿æ¥');
                wsStatus.textContent = 'âœ…';
                statusIndicator.classList.add('connected');
                statusText.textContent = 'å·²è¿æ¥';
                
                // æ³¨å†Œä¸ºéŸ³é¢‘å¼•æ“å®¢æˆ·ç«¯
                ws.send(JSON.stringify({
                    type: 'register_audio_engine',
                    timestamp: Date.now()
                }));
                
                addLog('ğŸµ å·²æ³¨å†Œä¸ºéŸ³é¢‘å¼•æ“');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // å¤„ç† OSC æ¶ˆæ¯
                    if (data.type === 'osc_to_audio') {
                        audioEngine.handleOSCMessage(data.address, data.args);
                        
                        // æ›´æ–°ç»Ÿè®¡
                        messageCounter++;
                        messageCount.textContent = messageCounter;
                        
                        // è®¡ç®—å»¶è¿Ÿ
                        const now = Date.now();
                        const msgLatency = now - (data.timestamp || now);
                        latency.textContent = msgLatency < 100 ? msgLatency : '100+';
                        lastMessageTime = now;
                    }
                } catch (error) {
                    addLog(`è§£ææ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                addLog(`WebSocket é”™è¯¯: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                addLog('âŒ WebSocket å·²æ–­å¼€', 'warning');
                wsStatus.textContent = 'âŒ';
                statusIndicator.classList.remove('connected');
                statusText.textContent = 'è¿æ¥æ–­å¼€';
                
                // 5ç§’åé‡è¿
                setTimeout(() => {
                    addLog('å°è¯•é‡æ–°è¿æ¥...');
                    connectWebSocket();
                }, 5000);
            };
        }
        
        // åˆ‡æ¢ç”Ÿæˆå¼éŸ³ä¹æŒ‰é’®äº‹ä»¶
        toggleMusicButton.addEventListener('click', () => {
            audioEngine.toggleGenerativeMusic();
            
            if (audioEngine.generativeMusic.isPlaying) {
                toggleMusicButton.textContent = 'â¸ï¸ æš‚åœç”Ÿæˆå¼éŸ³ä¹';
                toggleMusicButton.style.background = 'linear-gradient(45deg, #ff6b6b, #feca57)';
                addLog('â–¶ï¸ ç”Ÿæˆå¼éŸ³ä¹å·²æ¢å¤');
            } else {
                toggleMusicButton.textContent = 'â–¶ï¸ æ’­æ”¾ç”Ÿæˆå¼éŸ³ä¹';
                toggleMusicButton.style.background = 'linear-gradient(45deg, #00ff88, #00ffff)';
                addLog('â¸ï¸ ç”Ÿæˆå¼éŸ³ä¹å·²æš‚åœ');
            }
        });
        
        // å¯åŠ¨æŒ‰é’®äº‹ä»¶
        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            startButton.textContent = 'åˆå§‹åŒ–ä¸­...';
            
            try {
                addLog('æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘å¼•æ“...');
                await audioEngine.init();
                
                addLog('âœ… éŸ³é¢‘å¼•æ“åˆå§‹åŒ–æˆåŠŸ');
                startButton.textContent = 'âœ… éŸ³é¢‘å¼•æ“è¿è¡Œä¸­';
                startButton.style.background = 'linear-gradient(45deg, #00ff88, #00ffff)';
                
                // æ˜¾ç¤ºéŸ³ä¹æ§åˆ¶æŒ‰é’®
                toggleMusicButton.style.display = 'block';
                
                // è¿æ¥ WebSocket
                connectWebSocket();
                
                // æ‰“å°æ”¯æŒçš„ OSC åœ°å€
                const addresses = getAllAddresses();
                addLog(`ğŸ“¡ æ”¯æŒ ${addresses.length} ä¸ª OSC åœ°å€`);
                
            } catch (error) {
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                startButton.disabled = false;
                startButton.textContent = 'é‡è¯•å¯åŠ¨';
            }
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (audioEngine) {
                audioEngine.dispose();
            }
            if (ws) {
                ws.close();
            }
        });
        
        // åˆå§‹æ—¥å¿—
        addLog('ğŸµ Web Audio å¼•æ“å·²åŠ è½½');
        addLog('ğŸ“Œ ç‚¹å‡»"å¯åŠ¨éŸ³é¢‘å¼•æ“"æŒ‰é’®å¼€å§‹');
        addLog(`ğŸ“¡ ç³»ç»Ÿæ”¯æŒ ${getAllAddresses().length} ä¸ª OSC æ§åˆ¶åœ°å€`);
    </script>
</body>
</html>
